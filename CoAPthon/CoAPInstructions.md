# 50.053 Software Testing and Verification

### Fuzzing the Constrained Application Protocol (CoAP) implementation.


The goal of this task is to design and implement a fuzzer to gain hands-on experience in testing real, implemented protocols, specifically, either the Java (jCoAP) or Python (CoAPthon) implementation of the CoAP protocol.

### CoAP

Constrained Application Protocol (CoAP) is a UDP-based transport protocol developed for constrained devices, defined in RFC 7252. These are devices with limited memory, storage and computing power, limited battery power, and low bandwidth.


CoAP is like a limited HTTP, designed for constrained IoT devices. Similar to HTTP, it is client and server-based, where the client makes a request and the server sends a response. Also similar to HTTP, it is based on the REST mode.

#### REST model

The REST model is an architectural style that defines a set of constraints to create a uniform interface for communication between client and server. The primary data representation in REST is a resource, which is basically an abstraction of any type of information. Then you can use commands like GET, POST, PUT and DELETE to read, write and manipulate this resource. Every resource has a URI (Uniform Resource Identifier).

The below image illustrates the format of a CoAP message. 

<table style="width:100%">
  <tr>
    <td>
      <img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1706252962/Untitled_miccpv.png" alt="stack" width="500" height="auto"/>
    </td>
    <td>
      <img src="https://academy.nordicsemi.com/wp-content/uploads/2022/10/cellfund_less5_coap_protocol.png" alt="stack" width="800" height="auto"/>
    </td>
  </tr>
</table>

<p align="center">Figure 1. Protocol stack and frame structure.</p>


| CoAP message header | Description                                                |
|---------------------|------------------------------------------------------------|
| Ver                 | It is a 2-bit unsigned integer indicating the CoAP version number. This is set to 1, other values are reserved for future versions. |
| T                   | It is a 2-bit unsigned integer indicating the message type: confirmable (0), non-confirmable (1), ACK (2), or RESET (3). |
| TKL                 | It is a 4-bit unsigned integer indicating the length of the token (0 to 8 bytes). |
| Code                | It is an 8-bit unsigned integer split into two parts: a 3-bit class (MSBs) and a 5-bit detail (LSBs). Class (0-7) and detail (0-31), where class indicates request, success response or error response and detail gives additional information to the class. |
| Message ID          | It is a 16-bit unsigned integer used for matching responses and detecting message duplication. |
| Token                | A sequence of 0-8 bytes, which the server echoes in any response. The token is generated by the client and should be generated so they are unique and random|
| Optons                | number of options that can be included in a CoAP message|
|

<p align="center">
  <img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1706678953/Selection_122_nfgyoo.png" alt="messages" width="600" height="auto"/>
</p>
<p align="center">Figure 2. Examples of Confirmable and Non-confirmable CoAP messages</p>

## Server setup
To conduct this task, you need only one machine since you can run both the client and server using the same loopback interface. You can choose which implementation of the protocol you want to fuzz, either Java or Python. We provide a slightly modified version of CoAPthon where we have addressed some broken dependencies you might face when building from source.

### Build jCoAP from source

Step1: build both the **ws4d-jcoap-examples** and the **ws4d-jcoap** 

```bash
#if java not installed: https://www.oracle.com/java/technologies/downloads/ 
sudo apt install default-jre
java -version

#clone the repository
git clone https://gitlab.amd.e-technik.uni-rostock.de/ws4d/jcoap
cd jcoap/ws4d-jcoap

#if maven not installed 
sudo apt install maven -y
 
sudo mvn clean install

cd ../ws4d-jcoap-examples/
sudo mvn clean install
```

If any build issues encoutered due to incompatibility version, modify the version `1.6` to `1.8` in the `pom.xml` file as follows:

```xml
<plugin>
	<artifactId>maven-compiler-plugin</artifactId>
	<version>3.3</version>
	<configuration>
		<source>1.8</source>
		<target>1.8</target>
	</configuration>
</plugin>
```

Step2: copy the core file:

```bash
/jcoap/ws4d-jcoap/target/classes/org/ws4d/coap/core
to 
/jcoap/ws4d-jcoap-examples/target/classes/org/ws4d/coap

# (adjust your path accordingly):
sudo cp -r ~/Downloads/jcoap/ws4d-jcoap/target/classes/org/ws4d/coap/core ~/Downloads/jcoap/ws4d-jcoap-examples/target/classes/org/ws4d/coap
```

Step3: run the server 


You can run the server using a command as follows (you might need to adjust your path accordingly):

```
/usr/lib/jvm/java-1.11.0-openjdk-amd64/bin/java \
-javaagent:/home/asset/Downloads/idea-IU-233.13135.103/lib/idea_rt.jar=40677:/home/asset/Downloads/idea-IU-233.13135.103/bin \
-Dfile.encoding=UTF-8 \
-classpath \
/home/asset/Downloads/jcoap/ws4d-jcoap-examples/target/classes:\
/root/.m2/repository/org/apache/logging/log4j/log4j-core/2.6.2/log4j-core-2.6.2.jar:\
/root/.m2/repository/org/apache/logging/log4j/log4j-api/2.6.2/log4j-api-2.6.2.jar:\
/root/.m2/repository/org/ws4d/jcoap/jcoap-core/1.1.5/jcoap-core-1.1.5.jar \
org.ws4d.coap.example.basics.Server

```

(Recommended) You can use [IntelliJ](https://www.jetbrains.com/idea/download/) to run the server since it supports backtrace (the server dont support logs):

```bash
tar -xvf ideaIU-2023.X.X.tar.gz

cd idea-IC-231.8109.175/
sudo ./bin/idea.sh
```

open `/home/asset/Desktop/work/jcoap/ws4d-jcoap-examples` as a new mavean project  and go to `/home/asset/Desktop/work/jcoap/ws4d-jcoap-examples/target/classes/org/ws4d/coap/example/basics`, then right click the Server file and click on run. Specify your java SDK path if error prompt.


You will see an output in IntelliJ like this, indicating that the server is already running (127.0.0.1 on port 5683):

<p align="center">
  <img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1706252037/Selection_116_zszcfs.png" alt="animated" width="1000" height="auto"/>
</p>
<p align="center">Figure 3. Output logs from IntelliJ IDEA.</p>

You can ignore the error: `ERROR StatusLogger No log4j2 configuration file found. Using default configuration: logging only errors to the console`. The default configuration is enough to display the errors/bugs you will find in the console.

### Sending a request to the server in javascript

```javascript
const coap = require('coap');
const samplePayload = 'h'.repeat(1) + 'e'.repeat(1) + 'l'.repeat(1)  + 'o'.repeat(60)+'haha';
// const samplePayload = 'h'.repeat(10);


// samplePayload = samplePayload + 'end'
console.log('samplePayload.length: ', samplePayload.length);

const req = coap.request({
  host: '127.0.0.1',
  pathname: '/hello', // or /basic only in jCoAP
  port: 5683,
  method: 'POST',
  confirmable: true,
  options: {
    Size1: samplePayload.length,
    Block1: true,
  }
});

req.on('response', function (res) {
  console.log('POST request received response:');
  res.on('data', function (chunk) {
    console.log(chunk.toString());
  });
});

req.write(samplePayload);
req.end();
```

To run: 

```
sudo apt install nodejs
npm install chalk # coloring
node client_large_post.js
```

#### But, how does a crash and/or bug looks like in the server log?

In most of the cases in jCoAP you will see some `Exception`, Figure 4 shows an example of a bug when sending a mutated `PUT` request. 

<p align="center">
  <img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1706679166/Selection_123_dqtrly.png
" alt="backtrace" width="1200" height="auto"/>
</p>
<p align="center">Figure 4. Crash example view from the server backtrace. </p>

This is the stack trace of the `NullPointerException`, showing the sequence of method calls leading to the error. It starts from where the exception was thrown `(org.ws4d.coap.core.rest.BasicCoapResource.init)` and goes up through the call stack.

Overall, this backtrace indicates that while running a CoAP server, an error occurred due to a `NullPointerException` in the `BasicCoapResource` class at line `74` during initialization.


### Build CoAPthon

If you choose to setup the python version (have in mind that it is implemented in python 2), you can download the zip file of the code from edimension and set up as follows:

```bash
unzip CoAPthon.zip
cd CoAPthon/
python setup.py sdist
sudo pip install dist/CoAPthon-4.0.2.tar.gz -r requirements.txt
```

**Running:**


```bash
# install gdb debugger
sudo apt install gdb

sudo gdb -ex run -ex backtrace --args python2 coapserver.py -i 127.0.0.1 -p 5683 

# The server will list various endpoints that are available for 
# communication (i,e,./basic)
```

You will see the `gdb` debugger information as follows in your terminal once the server is running:

``` bash
GNU gdb (Ubuntu 12.1-0ubuntu1~22.04) 12.1
Copyright (C) 2022 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from python2...
(No debugging symbols found in python2)
Starting program: /usr/bin/python2 coapserver.py -i 127.0.0.1 -p 5683
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
[New Thread 0x7ffff6a3e640 (LWP 3993677)]
CoAP Server start on 127.0.0.1:5683
['/basic', '/storage', '/child', '/separate', '/etag', '/', '/big', '/encoding', '/advancedSeparate', '/void', '/advanced', '/long', '/xml']
```

### Creating a client/simple fuzzer

```python
from coapthon.client.helperclient import HelperClient
import random
import string

class CoAPFuzzer:
    def __init__(self, host, port):
        self.host = host
        self.port = port
        self.client = HelperClient(server=(self.host, self.port))
        self.original_payload = "Hello, CoAP!"

    def fuzz_payload(self, payload, num_bytes):
        # Generate random bytes to replace part of the payload
        fuzz_bytes = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(num_bytes))
        return payload[:3] + fuzz_bytes + payload[3 + num_bytes:]

    def fuzz_and_send_requests(self, num_requests, num_bytes):
        for _ in range(num_requests):
            fuzzed_payload = self.fuzz_payload(self.original_payload, num_bytes)
            print("Fuzzing payload:", fuzzed_payload)

            # Send fuzzed GET request with the fuzzed payload and path "/basic/"
            response = self.client.get("/basic", payload=fuzzed_payload)
            print(response.pretty_print())

    def close_connection(self):
        self.client.stop()

def main():
    host = "127.0.0.1"
    port = 5683

    fuzzer = CoAPFuzzer(host, port)
    #while(1):
    #    try:
    fuzzer.fuzz_and_send_requests(num_requests=3, num_bytes=5)
    #    except:
    fuzzer.close_connection()

if __name__ == "__main__":
    main()

```

The ouput of the backtrace should indicate the creation of new threads within the program. Threads are independent sequences of execution within the same process and the threads have exited properly.

From the `simple_fuzzing.py` script we can check that we send a first `GET` request with some random bytes in the payload: `HelmkzVQoAP!`

<p align="center">
  <img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1706587896/Selection_121_bmtcqq.png" alt="backtrace" width="1200" height="auto"/>
</p>
<p align="center">Figure 5. Backtrace logs from the server and fuzzing output. </p>


You can verify that the packet was sent by opening wiereshark and filtering by `coap` protocol in the filter bar on the top, you can note the highlighted payload in Figure 6.

<p align="center">
  <img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1706587731/Selection_120_bxhasx.png" alt="capture" width="1200" height="auto"/>
</p>
<p align="center">Figure 6. Wireshark capture showing the payload of the fuzzed CoAP frame.</p>



